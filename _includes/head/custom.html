<!-- 高可靠性可视化系统 - 零配置自动加载 -->
  <link rel="stylesheet" href="{{ '/assets/css/reliable-visualization.css' | relative_url }}">
  <script src="{{ '/assets/js/reliable-visualization.js' | relative_url }}" defer></script>

  <!-- MathJax 数学公式支持 - 自动检测 -->
  <script>
    // 自动检测数学公式并加载MathJax
    (function() {
      const hasMath = document.querySelector('script[type="math/tex"], .math, \\(, \\[');
      if (hasMath || document.querySelector('[data-mathjax]')) {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
        script.async = true;
        document.head.appendChild(script);
        
        window.MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
          }
        };
      }
    })();
  </script>

<!-- 自定义头部内容 -->
<!-- 主题切换和可视化库集成 -->

<!-- 主题切换脚本 -->
<script>
// 主题管理
const ThemeManager = {
  // 获取当前主题
  getCurrentTheme() {
    return localStorage.getItem('theme') || '{{ site.theme.switcher.default | default: "light" }}';
  },
  
  // 设置主题
  setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    
    // 更新图表主题
    if (window.updateChartTheme) {
      window.updateChartTheme(theme);
    }
  },
  
  // 切换主题
  toggleTheme() {
    const currentTheme = this.getCurrentTheme();
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    this.setTheme(newTheme);
  },
  
  // 初始化主题
  init() {
    const theme = this.getCurrentTheme();
    this.setTheme(theme);
    
    // 添加主题切换按钮事件
    document.addEventListener('DOMContentLoaded', () => {
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', () => this.toggleTheme());
      }
    });
  }
};

// 初始化主题
ThemeManager.init();
</script>

<!-- 可视化库集成 -->
{% include visualization-libs.html %}

<!-- 性能优化脚本 -->
<script>
// 性能监控
const PerformanceMonitor = {
  // 页面加载时间
  pageLoadTime: 0,
  
  // 初始化监控
  init() {
    this.startTime = performance.now();
    
    window.addEventListener('load', () => {
      this.pageLoadTime = performance.now() - this.startTime;
      console.log(`页面加载时间: ${this.pageLoadTime.toFixed(2)}ms`);
    });
  },
  
  // 资源加载监控
  monitorResourceLoading() {
    const observer = new PerformanceObserver((list) => {
      list.getEntries().forEach((entry) => {
        if (entry.entryType === 'resource') {
          console.log(`资源加载: ${entry.name} - ${entry.duration.toFixed(2)}ms`);
        }
      });
    });
    
    observer.observe({ entryTypes: ['resource'] });
  }
};

// 初始化性能监控
PerformanceMonitor.init();
PerformanceMonitor.monitorResourceLoading();
</script>

<!-- 图片懒加载 -->
<script>
// 图片懒加载
const ImageLazyLoader = {
  init() {
    if ('IntersectionObserver' in window) {
      const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            img.src = img.dataset.src;
            img.classList.remove('lazy');
            img.classList.add('loaded');
            observer.unobserve(img);
          }
        });
      });
      
      document.querySelectorAll('img[data-src]').forEach(img => {
        imageObserver.observe(img);
      });
    }
  }
};

// 初始化图片懒加载
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => ImageLazyLoader.init());
} else {
  ImageLazyLoader.init();
}
</script>

<!-- 代码复制功能 -->
<script>
// 代码复制功能
const CodeCopy = {
  init() {
    document.querySelectorAll('pre code').forEach(block => {
      const button = document.createElement('button');
      button.className = 'copy-button';
      button.textContent = '复制';
      button.style.cssText = `
        position: absolute;
        top: 8px;
        right: 8px;
        padding: 4px 8px;
        background: rgba(0,0,0,0.1);
        border: none;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
      `;
      
      const pre = block.parentElement;
      pre.style.position = 'relative';
      pre.appendChild(button);
      
      pre.addEventListener('mouseenter', () => button.style.opacity = '1');
      pre.addEventListener('mouseleave', () => button.style.opacity = '0');
      
      button.addEventListener('click', () => {
        navigator.clipboard.writeText(block.textContent).then(() => {
          button.textContent = '已复制';
          setTimeout(() => button.textContent = '复制', 2000);
        });
      });
    });
  }
};

// 初始化代码复制
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => CodeCopy.init());
} else {
  CodeCopy.init();
}
</script>

<!-- 搜索功能 -->
<script>
// 搜索功能
const SearchManager = {
  init() {
    const searchInput = document.getElementById('search-input');
    if (searchInput) {
      searchInput.addEventListener('input', this.debounce(this.handleSearch, 300));
    }
  },
  
  handleSearch(event) {
    const query = event.target.value.toLowerCase();
    const posts = document.querySelectorAll('.post-card');
    
    posts.forEach(post => {
      const title = post.querySelector('h3').textContent.toLowerCase();
      const excerpt = post.querySelector('.post-excerpt')?.textContent.toLowerCase() || '';
      
      if (title.includes(query) || excerpt.includes(query)) {
        post.style.display = 'block';
      } else {
        post.style.display = 'none';
      }
    });
  },
  
  debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
};

// 初始化搜索
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => SearchManager.init());
} else {
  SearchManager.init();
}
</script>
