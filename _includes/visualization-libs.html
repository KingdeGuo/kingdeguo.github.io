<!-- 重构后的可视化库集成 -->
<!-- 使用新的简化引擎，支持按需加载和智能错误处理 -->

<!-- 核心样式 -->
<style>
/* 可视化容器基础样式 */
.visualization-container {
  width: 100%;
  min-height: 400px;
  margin: 2rem 0;
  border-radius: 12px;
  overflow: hidden;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  position: relative;
}

/* 深色主题适配 */
[data-theme="dark"] .visualization-container {
  background: rgba(30, 30, 30, 0.95);
  border-color: rgba(255, 255, 255, 0.1);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

/* 加载状态 */
.visualization-container.loading::after {
  content: "正在加载图表...";
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 14px;
  color: #666;
  z-index: 10;
  background: rgba(255, 255, 255, 0.9);
  padding: 10px 20px;
  border-radius: 20px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

[data-theme="dark"] .visualization-container.loading::after {
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
}

/* 错误状态 */
.visualization-container.error {
  background: rgba(255, 0, 0, 0.05);
  border-color: rgba(255, 0, 0, 0.2);
}

.visualization-container.error::after {
  content: attr(data-error);
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 14px;
  color: #ff4444;
  text-align: center;
  padding: 20px;
  width: 100%;
  z-index: 10;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 8px;
}

[data-theme="dark"] .visualization-container.error::after {
  background: rgba(0, 0, 0, 0.9);
  color: #ff6b6b;
}

/* 成功状态 */
.visualization-container.success {
  animation: fadeIn 0.3s ease-in-out;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .visualization-container {
    min-height: 300px;
    border-radius: 8px;
  }
}

@media (max-width: 480px) {
  .visualization-container {
    min-height: 250px;
  }
}

/* 动画效果 */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* 特定图表类型样式 */
.mermaid {
  text-align: center;
  margin: 20px 0;
  background: transparent;
}

.mermaid svg {
  max-width: 100%;
  height: auto;
}

[data-theme="dark"] .mermaid text {
  fill: #e9ecef !important;
}

[data-theme="dark"] .mermaid .node rect,
[data-theme="dark"] .mermaid .node circle,
[data-theme="dark"] .mermaid .node ellipse,
[data-theme="dark"] .mermaid .node polygon {
  fill: #495057 !important;
  stroke: #6c757d !important;
}

[data-theme="dark"] .mermaid .edgePath .path {
  stroke: #6c757d !important;
}

[data-theme="dark"] .mermaid .edgeLabel {
  background-color: #495057 !important;
  color: #e9ecef !important;
}

/* Chart.js 容器 */
.chartjs-container {
  position: relative;
  height: 400px;
  padding: 20px;
}

/* ECharts 容器 */
.echarts-container {
  height: 400px;
  padding: 20px;
}

/* Plotly 容器 */
.plotly-chart {
  height: 400px;
  padding: 20px;
}
</style>

<!-- 核心引擎脚本 -->
<script src="{{ '/assets/js/reliable-visualization.js' | relative_url }}"></script>

<!-- 预加载脚本已移除，以解决与主渲染引擎的冲突 -->

<!-- 工具函数 -->
<script>
// 便捷的图表创建函数
window.createChart = {
  // 创建ECharts图表
  echarts: function(element, options) {
    return window.VisualizationEngine.render('echarts', element, options);
  },
  
  // 创建Chart.js图表
  chartjs: function(element, config) {
    return window.VisualizationEngine.render('chartjs', element, config);
  },
  
  // 创建Mermaid图表
  mermaid: function(element, code) {
    return window.VisualizationEngine.render('mermaid', element, { code });
  },
  
  // 创建Plotly图表
  plotly: function(element, data, layout, config) {
    return window.VisualizationEngine.render('plotly', element, { data, layout, config });
  }
};

// 主题切换辅助函数
window.updateChartTheme = function(theme) {
  // 重新渲染所有图表以适配新主题
  window.VisualizationEngine._reRenderAll();
};

// 错误重试函数
window.retryChart = function(elementId) {
  window.VisualizationEngine.retry(elementId);
};
</script>
