<!-- Mermaid图表支持 (Robust Version 2) -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const html = document.documentElement;
    const isDark = html.getAttribute('data-theme') === 'dark';

    mermaid.initialize({
      startOnLoad: false, // We will render manually
      theme: isDark ? 'dark' : 'default',
      themeVariables: {
        background: isDark ? '#1a202c' : '#ffffff',
        primaryColor: isDark ? '#2d3748' : '#f9f9f9',
        secondaryColor: isDark ? '#4a5568' : '#e0e0e0',
        tertiaryColor: isDark ? '#2d3748' : '#f9f9f9',
        primaryTextColor: isDark ? '#f0f0f0' : '#333',
        secondaryTextColor: isDark ? '#a0aec0' : '#555',
        tertiaryTextColor: isDark ? '#718096' : '#777',
        primaryBorderColor: isDark ? '#4a5568' : '#333',
        secondaryBorderColor: isDark ? '#a0aec0' : '#ddd',
        tertiaryBorderColor: isDark ? '#718096' : '#eee',
        lineColor: isDark ? '#a0aec0' : '#333',
        nodeBkg: isDark ? '#2d3748' : '#f9f9f9',
        nodeBorder: isDark ? '#a0aec0' : '#333',
        clusterBkg: isDark ? 'rgba(74, 85, 104, 0.3)' : 'rgba(238, 238, 238, 0.5)',
        clusterBorder: isDark ? '#a0aec0' : '#aaa',
        arrowheadColor: isDark ? '#a0aec0' : '#333',
        classText: isDark ? '#f0f0f0' : '#333',
      }
    });

    const renderMermaidDiagrams = async () => {
      // Handle both code blocks and div elements
      const mermaidElements = document.querySelectorAll('code.language-mermaid, div.mermaid');
      
      for (const [index, element] of mermaidElements.entries()) {
        let code;
        let id = `mermaid-graph-${index}`;
        
        if (element.tagName === 'CODE') {
          code = element.innerText;
          const container = document.createElement('div');
          container.className = 'mermaid-diagram-container';
          const codeWrapper = element.closest('.highlighter-rouge') || element.parentElement;
          codeWrapper.parentNode.replaceChild(container, codeWrapper);
        } else if (element.tagName === 'DIV') {
          code = element.textContent.trim();
          id = element.id || id;
          element.innerHTML = ''; // Clear existing content
        }
        
        try {
          const { svg } = await mermaid.render(id, code);
          if (element.tagName === 'CODE') {
            container.innerHTML = svg;
          } else if (element.tagName === 'DIV') {
            element.innerHTML = svg;
          }
        } catch (e) {
          console.error(`Mermaid render error for diagram ${index}:`, e);
          
          const errorDiv = document.createElement('div');
          errorDiv.style.cssText = 'padding: 15px; background-color: #ffdddd; border: 1px solid #ff0000; color: #d8000c; border-radius: 5px; margin-bottom: 20px; font-family: sans-serif;';
          
          const sanitizedCode = code.replace(/</g, '<').replace(/>/g, '>');
          errorDiv.innerHTML = `
            <strong style="font-size: 1.1em;">Mermaid 图表渲染失败</strong>
            <p style="margin-top: 10px;">错误: ${e.message}</p>
            <p style="margin-top: 10px;"><strong>问题代码:</strong></p>
            <pre style="background-color: #f1f1f1; padding: 10px; border-radius: 3px; white-space: pre-wrap; word-wrap: break-word; color: #333;">${sanitizedCode}</pre>
          `;
          if (element.tagName === 'CODE') {
            container.appendChild(errorDiv);
          } else if (element.tagName === 'DIV') {
            element.appendChild(errorDiv);
          }
        }
      }
    };

    renderMermaidDiagrams();
  });
</script>
